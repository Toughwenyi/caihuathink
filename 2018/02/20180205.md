# 20180205

**肖威工作总结**
- 上午：阿里云部署实战
（1）域名对接：将服务器的ip加入域名解析的栏目，实现www 和 @ 的域名的解析；
  使用ping dongnishijian.com 看是否被解析；
（2）登录服务器：ssh root@100.10.100.10 完成密码的更新；
（3）在我们的远程电脑上安装相关的运行程序和 ruby on rails 的运行环境；
  https://www.jianshu.com/p/04328ed5970e

  今天处理 ssh连接至 ubuntu 服务器时，提示以下错误：

    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    @ WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED! @
    @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
    IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
    Someone could be eavesdropping on you right now (man-in-the-middle attack)!
    It is also possible that a host key has just been changed.
    The fingerprint for the RSA key sent by the remote host is
    da:f7:3e:ba:f7:00:e6:44:76:f2:58:6e:48:******.
    Please contact your system administrator.
    Add correct host key in /用户home目录/.ssh/known_hosts to get rid of this message.
    Offending RSA key in /用户home目录/.ssh/known_hosts:1
    RSA host key for ip地址 has changed and you have requested strict checking.
    Host key verification failed.

经过google,出现这个问题的原因是,第一次使用SSH连接时，会生成一个认证，储存在客户端的known_hosts中.
可使用以下指令查看：

    ssh-keygen -l -f ~/.ssh/known_hosts

由于服务器重新安装系统了，所以会出现以上错误。
解决办法

    ssh-keygen -R 服务器端的ip地址

会出现以下提示：

    Host 192.168.3.10 found: line 1 type RSA

/用户home目录/.ssh/known_hosts updated.
Original contents retained as /用户home目录/.ssh/known_hosts.old
重新连线,出现以下提示：

    The authenticity of host '192.168.3.10 (192.168.3.10)' can't be established.
    RSA key fingerprint is da:f7:3e:ba:f7:00:e6:44:76:f2:58:6e:48:****.
    Are you sure you want to continue connecting (yes/no)?

输入yes确认即可连线成功.

作者：GkFool
链接：https://www.jianshu.com/p/04328ed5970e
來源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

https://www.jianshu.com/p/47da77b969cc
ubuntu14.04 安装 Rails 环境, Nginx Passenger

ubuntu14.04 安装 Rails 环境, Nginx Passenger

新建部署用户

# 创建新用户-dep
sudo useradd -m -s /bin/bash dep
sudo adduser dep sudo
sudo passwd

# 安装ssh远程连接
sudo apt-get install update
sudo apt-get install ssh

# 查看机器IP
ifconfig
# login as dep
安装ruby


sudo apt-get install curl
# 安装 RVM
\curl -sSL https://get.rvm.io | bash
# 激活 RVM
source .bashrc
# 产看RVM版本
rvm -v
# 用RVM安装Ruby
rvm install 2.3.0
# 查看RVM下所有ruby版本
rvm list
# 指定默认ruby
rvm alias create default 2.3.0
# 查看ruby命名位置
which ruby
# /home/dep/.rvm/rubies/ruby-2.3.0/bin/ruby
安装Nginx和Passenger


# APT安装 nginx+passenger
# 参考 https://www.phusionpassenger.com/library/install/nginx/install/oss/trusty/
# Install our PGP key and add HTTPS support for APT
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7
sudo apt-get install -y apt-transport-https ca-certificates

# Add our APT repository
sudo sh -c 'echo deb https://oss-binaries.phusionpassenger.com/apt/passenger trusty main > /etc/apt/sources.list.d/passenger.list'
sudo apt-get update

# Install Passenger + Nginx
sudo apt-get install -y nginx-extras passenger
安装依赖工具

# 安装nodejs，后面会有依赖
sudo apt-get install nodejs
# 安装Git
sudo apt-get install git
配置 Nginx

sudo vi /etc/nginx/nginx.conf
# 去掉下面两行的注释
# passenger_root /some-filename/locations.ini;
# passenger_ruby /usr/bin/passenger_free_ruby;

# 修改Nginx配置
sudo rm /etc/nginx/sites-enabled/default
sudo vi /etc/nginx/sites-enabled/example.com.conf

server {
    listen 80 default;
    server_name ror.cbd; # 如果是本地VM调试修改hosts文件
    root /home/deploy/code_from_git/toy_app/public;

    passenger_enabled on;
}
部署代码

# clone 代码

# bundle安装gems
gem install bundle
# 如果失败了就切回ruby-china的源
gem sources --add https://gems.ruby-china.org/ --remove https://rubygems.org/
gem sources -l

# 进入项目目录
bundle install
# 查看服务器的secret值
rake secret

# 在config/secrets.yml，替换掉production设置中的 <%= ENV["SECRET_KEY_BASE"] %>
# 或者在环境变量里添加；
# 或者在production的组里添加 dotenv-rails 这个gem，之后在项目根目录下新建 .env 文件，添加配置
SECRET_KEY_BASE=b78a0f839f2be596a1543f13bb90b965d5736dcb190504b10c3de05eb2fcb66d1ab6d92b3450e603e5768bba1830604a506bcb5a0f6040ec110b2f55e2a2a78e

# 代码 push && pull

# 设置Rails运行环境 并 运行DB 迁移
RAILS_ENV=production rake db:create db:migrate
完成

# 重启 Nginx
sudo service nginx restart
at 2016-03-22

作者：CbdFocus
链接：https://www.jianshu.com/p/47da77b969cc
來源：简书
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

Nginx 通过 passenger-install-nginx-module 安装的 nginx 和直接安装的 nginx 有什么区别？
https://ruby-china.org/topics/16303
- 下午：办公工位交接
--------------------------------------------
不可以向下进行，这是现在所遇到的问题；
Where do you want to install Nginx to?

Please specify a prefix directory [/opt/nginx]:

--------------------------------------------

Compiling Passenger support files...
# env NOEXEC_DISABLE=1 /home/apps/.rvm/gems/ruby-2.3.1/wrappers/rake nginx:clean nginx RELEASE=yes
rm -rf buildout/cache
rm -rf buildout/common/libboost_oxt.a buildout/common/libboost_oxt
rm -f buildout/common/libpassenger_common/LoggingKit.o buildout/common/libpassenger_common/Exceptions.o buildout/common/libpassenger_common/FileTools/PathManip.o buildout/common/libpassenger_common/FileTools/FileManip.o buildout/common/libpassenger_common/ProcessManagement/Spawn.o buildout/common/libpassenger_common/ProcessManagement/Utils.o buildout/common/libpassenger_common/Utils/SystemTime.o buildout/common/libpassenger_common/Utils/StrIntUtils.o buildout/common/libpassenger_common/Utils/StrIntUtilsNoStrictAliasing.o buildout/common/libpassenger_common/Utils/IOUtils.o buildout/common/libpassenger_common/Utils/Hasher.o buildout/common/libpassenger_common/Utils.o buildout/common/libpassenger_common/jsoncpp.o
rm -f buildout/common/libpassenger_common/Crypto.o buildout/common/libpassenger_common/Utils/CachedFileStat.o buildout/common/libpassenger_common/WatchdogLauncher.o buildout/common/libpassenger_common/MemoryKit/mbuf.o buildout/common/libpassenger_common/MemoryKit/palloc.o buildout/common/libpassenger_common/ServerKit/http_parser.o buildout/common/libpassenger_common/ServerKit/Implementation.o buildout/common/libpassenger_common/DataStructures/LString.o buildout/common/libpassenger_common/AppTypes.o
rm -f buildout/common/libpassenger_common/vendor-modified/modp_b64.o buildout/common/libpassenger_common/vendor-modified/modp_b64_strict_aliasing.o
rm -f buildout/common/libpassenger_common/UnionStationFilterSupport.o
rm -f buildout/common/libpassenger_common/JsonTools/CBindings.o
rm -f buildout/common/libpassenger_common/FileTools/LargeFiles.o
rm -f buildout/common/libpassenger_common/FileTools/PathManipCBindings.o
rm -f buildout/common/libpassenger_common/ProcessManagement/Ruby.o
rm -rf buildout/common/libpassenger_common
rm -rf buildout/support-binaries/
rm -rf buildout/nginx_dynamic/libboost_oxt.a buildout/nginx_dynamic/libboost_oxt
rm -f buildout/nginx_dynamic/module_libpassenger_common/LoggingKit.o buildout/nginx_dynamic/module_libpassenger_common/Exceptions.o buildout/nginx_dynamic/module_libpassenger_common/FileTools/PathManip.o buildout/nginx_dynamic/module_libpassenger_common/FileTools/FileManip.o buildout/nginx_dynamic/module_libpassenger_common/ProcessManagement/Spawn.o buildout/nginx_dynamic/module_libpassenger_common/ProcessManagement/Utils.o buildout/nginx_dynamic/module_libpassenger_common/Utils/SystemTime.o buildout/nginx_dynamic/module_libpassenger_common/Utils/StrIntUtils.o buildout/nginx_dynamic/module_libpassenger_common/Utils/StrIntUtilsNoStrictAliasing.o buildout/nginx_dynamic/module_libpassenger_common/Utils/IOUtils.o buildout/nginx_dynamic/module_libpassenger_common/Utils/Hasher.o buildout/nginx_dynamic/module_libpassenger_common/Utils.o buildout/nginx_dynamic/module_libpassenger_common/jsoncpp.o
rm -f buildout/nginx_dynamic/module_libpassenger_common/Crypto.o buildout/nginx_dynamic/module_libpassenger_common/Utils/CachedFileStat.o buildout/nginx_dynamic/module_libpassenger_common/WatchdogLauncher.o buildout/nginx_dynamic/module_libpassenger_common/MemoryKit/mbuf.o buildout/nginx_dynamic/module_libpassenger_common/MemoryKit/palloc.o buildout/nginx_dynamic/module_libpassenger_common/ServerKit/http_parser.o buildout/nginx_dynamic/module_libpassenger_common/ServerKit/Implementation.o buildout/nginx_dynamic/module_libpassenger_common/DataStructures/LString.o buildout/nginx_dynamic/module_libpassenger_common/AppTypes.o
rm -f buildout/nginx_dynamic/module_libpassenger_common/vendor-modified/modp_b64.o buildout/nginx_dynamic/module_libpassenger_common/vendor-modified/modp_b64_strict_aliasing.o
rm -f buildout/nginx_dynamic/module_libpassenger_common/UnionStationFilterSupport.o
rm -f buildout/nginx_dynamic/module_libpassenger_common/JsonTools/CBindings.o
rm -f buildout/nginx_dynamic/module_libpassenger_common/FileTools/LargeFiles.o
rm -f buildout/nginx_dynamic/module_libpassenger_common/FileTools/PathManipCBindings.o
rm -f buildout/nginx_dynamic/module_libpassenger_common/ProcessManagement/Ruby.o
rm -rf buildout/nginx_dynamic/module_libpassenger_common
mkdir -p buildout/support-binaries
c++ -o buildout/support-binaries/AgentMain.o  -Isrc/agent -Isrc/cxx_supportlib -Isrc/cxx_supportlib/vendor-copy -Isrc/cxx_supportlib/vendor-modified -Isrc/cxx_supportlib/vendor-modified/libev -Isrc/cxx_supportlib/vendor-copy/libuv/include -Isrc/cxx_supportlib/vendor-copy/websocketpp -D_REENTRANT -I/usr/local/include -Wall -Wextra -Wno-unused-parameter -Wno-parentheses -Wpointer-arith -Wwrite-strings -Wno-long-long -Wno-missing-field-initializers -feliminate-unused-debug-symbols -feliminate-unused-debug-types -fvisibility=hidden -DVISIBILITY_ATTRIBUTE_SUPPORTED -Wno-attributes -DHAS_ALLOCA_H -DHAVE_ACCEPT4 -DHAS_SFENCE -DHAS_LFENCE -DPASSENGER_DEBUG -DBOOST_DISABLE_ASSERTS -ggdb -std=gnu++11 -Wno-unused-local-typedefs -DHASH_NAMESPACE="gnu_cxx" -DHASH_MAP_HEADER="<hash_map>" -DHASH_MAP_CLASS="hash_map" -DHASH_FUN_H="<hash_fun.h>" -c src/agent/AgentMain.cpp
c++ -o buildout/support-binaries/AgentFundamentals.o  -Isrc/agent -Isrc/cxx_supportlib -Isrc/cxx_supportlib/vendor-copy -Isrc/cxx_supportlib/vendor-modified -Isrc/cxx_supportlib/vendor-modified/libev -Isrc/cxx_supportlib/vendor-copy/libuv/include -Isrc/cxx_supportlib/vendor-copy/websocketpp -D_REENTRANT -I/usr/local/include -Wall -Wextra -Wno-unused-parameter -Wno-parentheses -Wpointer-arith -Wwrite-strings -Wno-long-long -Wno-missing-field-initializers -feliminate-unused-debug-symbols -feliminate-unused-debug-types -fvisibility=hidden -DVISIBILITY_ATTRIBUTE_SUPPORTED -Wno-attributes -DHAS_ALLOCA_H -DHAVE_ACCEPT4 -DHAS_SFENCE -DHAS_LFENCE -DPASSENGER_DEBUG -DBOOST_DISABLE_ASSERTS -ggdb -std=gnu++11 -Wno-unused-local-typedefs -DHASH_NAMESPACE="gnu_cxx" -DHASH_MAP_HEADER="<hash_map>" -DHASH_MAP_CLASS="hash_map" -DHASH_FUN_H="<hash_fun.h>" -c src/agent/Shared/Fundamentals/Implementation.cpp
c++ -o buildout/support-binaries/WatchdogMain.o  -Isrc/agent -Isrc/cxx_supportlib -Isrc/cxx_supportlib/vendor-copy -Isrc/cxx_supportlib/vendor-modified -Isrc/cxx_supportlib/vendor-modified/libev -Isrc/cxx_supportlib/vendor-copy/libuv/include -Isrc/cxx_supportlib/vendor-copy/websocketpp -D_REENTRANT -I/usr/local/include -Wall -Wextra -Wno-unused-parameter -Wno-parentheses -Wpointer-arith -Wwrite-strings -Wno-long-long -Wno-missing-field-initializers -feliminate-unused-debug-symbols -feliminate-unused-debug-types -fvisibility=hidden -DVISIBILITY_ATTRIBUTE_SUPPORTED -Wno-attributes -DHAS_ALLOCA_H -DHAVE_ACCEPT4 -DHAS_SFENCE -DHAS_LFENCE -DPASSENGER_DEBUG -DBOOST_DISABLE_ASSERTS -ggdb -std=gnu++11 -Wno-unused-local-typedefs -DHASH_NAMESPACE="gnu_cxx" -DHASH_MAP_HEADER="<hash_map>" -DHASH_MAP_CLASS="hash_map" -DHASH_FUN_H="<hash_fun.h>" -c src/agent/Watchdog/WatchdogMain.cpp


- 晚上：云端支付逻辑


[ 2.0 ] 9. 將寫好的專案部署 ( Deploy ) 到遠端 Server 上
（逻辑稍微简单一些）
http://rails101s.logdown.com/posts/247891-project-deploy-on-the-server

[ 2.0 ] 9. 將寫好的專案部署 ( Deploy ) 到遠端 Server 上
本章的作業目標:

用手動的方式將寫好的 Rails 專案 deploy 到遠端 Server 上
改 Capristrano 自動化部署，一個指令完成 Deploy
用手動的方式將寫好的 Rails 專案 deploy 到遠端 Server 上
本機端的前置作業
打開根目錄的 .gitignore ，輸入

.gitignore
...
...
+ /config/database.yml
...
...
這個設定會將 config/database.yml 從版本控制中移除

Gemfile 修改
原本

Gemfile
...
...
- gem 'sqlite3'
+ # gem 'sqlite3'
...
- # gem 'therubyracer', platforms: :ruby
+ gem 'therubyracer', platforms: :ruby
...
+ group :development do
+   gem "sqlite3"
+ end

+ group :production do
+   gem "mysql2"
+ end
...
...
config/initializers/devise.rb 修改
config/initializers/devise.rb
...
...
-  # config.secret_key = '（一堆亂碼)'
+  config.secret_key = '（一堆亂碼)'
...
...
最後將寫好的專案放到你的 github 上 ( 如果要看範例教材在 https://github.com/sdlong/rails101s )

Production 端設定
作業系統版本: Ubuntu 14.04 LTS @linode

我們會在 production 上創建二個帳號
一個是 root ( 擁有最高權限，系統安裝與設定用 )
一個是 apps ( deploy 用，沒有系統異動權限 )

所有系統安裝都是用 root 權限的帳號來設定

現在我們已經進入全新剛建好的 Ubuntu 14.04


系統更新
sudo apt-get update
sudo apt-get upgrade
sudo apt-get autoremove

設定時區
sudo dpkg-reconfigure tzdata

安裝 MySQL
sudo apt-get install mysql-common mysql-client libmysqlclient-dev mysql-server
會要你輸入 mysql 的 root 密碼 ( 這邊以 123456 為範例，後面會有資料庫設定 )

mysql -u root -p => 輸入 root 密碼 ( 本範例是 123456 )

看到這個畫面就代表安裝成功 ( 打 exit 離開 )


安裝需要的套件 ( 含 git )
sudo apt-get install build-essential git-core curl libssl-dev libreadline5 libreadline-gplv2-dev zlib1g zlib1g-dev libmysqlclient-dev libcurl4-openssl-dev libxslt-dev libxml2-dev libffi-dev

安裝 rbenv
sudo git clone git://github.com/sstephenson/rbenv.git /usr/local/rbenv

sudo vi /etc/profile.d/rbenv.sh
檔案裡面寫入:

 export RBENV_ROOT=/usr/local/rbenv
export PATH="$RBENV_ROOT/bin:$PATH"
eval "$(rbenv init -)"
存檔

修改檔案權限

sudo chmod +x /etc/profile.d/rbenv.sh

安裝 ruby-build

git clone git://github.com/sstephenson/ruby-build.git /tmp/ruby-build
sudo /tmp/ruby-build/install.sh

安裝 ruby ( 本次用 2.3.0 版本 )
rbenv install 2.3.0
rbenv global 2.3.0
rbenv rehash

ruby -v

看到這張圖就代表安裝完成

(PS: 舊圖是 2.1.2, 實際上應該要是 2.3.0 )

安裝 ImageMagick
apt-get install imagemagick

安裝 Passenger
gem install passenger

用 Passenger 安裝 Nginx
passenger-install-nginx-module

第一個選擇 1. Yes: download,
第二個選擇 1. compile and install Nginx for me.
第三個選擇: 安裝到 /opt/nginx (直接按 enter)
安裝 Nginx init script
git clone git://github.com/jnstq/rails-nginx-passenger-ubuntu.git
sudo mv rails-nginx-passenger-ubuntu/nginx/nginx /etc/init.d/nginx
sudo chown root:root /etc/init.d/nginx

設定 Nginx conf
vim /opt/nginx/conf/nginx.conf

/opt/nginx/conf/nginx.conf
...
...
  server {       
       listen 80;
       server_name localhost;
+      root /home/apps/rails101s/public;   # 這行會對應到你的專案資料夾名稱，如果你不是用rails101s，就把 rails101s 改成你的專案名稱
+      passenger_enabled on;     

-       #charset koi8-r;
-       #access_log  logs/host.access.log  main;

-       location / {
-           root   html;
-           index  index.html index.htm;
-       }

-       #error_page  404              /404.html;
-       # redirect server error pages to the static page /50x.html
-       #
-       error_page   500 502 503 504  /50x.html;
-       location = /50x.html {
-           root   html;
-       }

-       # proxy the PHP scripts to Apache listening on 127.0.0.1:80
-       #
-       #location ~ \.php$ {
-       #    proxy_pass   http://127.0.0.1;
-       #}

-       # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
-       #
-       #location ~ \.php$ {
-       #    root           html;
-       #    fastcgi_pass   127.0.0.1:9000;
-       #    fastcgi_index  index.php;
-       #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
-       #    include        fastcgi_params;
-       #}

-       # deny access to .htaccess files, if Apache's document root
-       # concurs with nginx's one
-       #
-       #location ~ /\.ht {
-       #    deny  all;
-       #}
    }
...
...
將 nginx server 重開機

sudo /etc/init.d/nginx restart
出現這個畫面，代表 nginx server 安裝成功，可以運作了


連到該 server 的 ip / 網址

root 帳號的系統設定完成，接下來做 apps 帳號的設定

安裝必要的 gem
gem install bundle
gem install execjs

新增 User: apps
sudo adduser apps
輸入密碼與相關資料

切換 User: apps
sudo su - apps

確認 ruby 版本是否為安裝的 2.3.0
ruby -v

若不是 2.3.0 ，可改用 ssh apps@ip 用 apps 登入
再檢查一次版本是否正確，正確才執行下面的動作

ssh-keygen => 連按三個 enter
more ~/.ssh/id_rsa.pub # 把出來的內容貼到 github account setting => ssh_key 上
git clone git@github.com:sdlong/rails101s.git ( 此為範例用，或是你的 git )

設定 config/database.yml
vim ~/rails101s/config/database.yml

config/database.yml
production:
  adapter: mysql2
  encoding: utf8
  database: rails101
  pool: 5
  username: root
  password: "123456"
  socket: /var/run/mysqld/mysqld.sock
username 跟 password 的值就是你安裝 MySQL 時設定的值

安裝專案需要的 gem 與 rails rake 執行
cd rails101
bundle install
RAILS_ENV=production rake db:create # 建立 production database
RAILS_ENV=production rake db:migrate # 建立 production database 欄位
RAILS_ENV=production rake assets:precompile # 建立 production assets

檢查是否 deploy 成功
重開 nginx server
sudo /etc/init.d/nginx restart

會發現這個問題

這是因為我們的 config/secret.yml 裡面沒有 production 的密碼


vi config/secrets.yml

把 其中的一行 密碼 貼到 production 那一行，存檔即可

再重開 nginx server
sudo /etc/init.d/nginx restart


Deploy 完成！！

改 Capristrano 自動化部署，一個指令完成 Deploy
我們會發現，每次網站一改版，就要重新 git clone , 設定 database.yml, secret.yml, 跑一系列 rake 指令
要花太多人工的時間，而且很難確保不會在手動執行的過程中手殘造成悲劇

所以我們改用自動化部署，來幫助我們自動處理，而且還有 rollback 的功能，萬一本次的版本炸掉，還能回溯上個版本

前置作業
(本機端)
more ~/.ssh/id_rsa.pub

copy 出來的值

(用 apps 登入 production server )

vim /home/apps/.ssh/authorized_keys
=> 貼上 copy 的值，存檔

以後就可以在開發端用 $ ssh apps@(server.ip) 直接連過去

建立 rails101s/shared/config 資料夾
mkdir ~/rails101s/shared
mkdir ~/rails101s/shared/config

將 rails101s/config 裡的 database.yml 跟 secret.yml 複製到 rails101s/shared/config 資料夾
cp ~/rails101s/config/database.yml ~/rails101s/shared/config/
cp ~/rails101s/config/secrets.yml ~/rails101s/shared/config/

開發端設定
安裝 gem
打開 Gemfile

Gemfile
...
...
group :development do
  gem "sqlite3"
+ gem "capistrano",  "~> 3.1", require: false
+ gem "capistrano-rvm", "~> 0.1.1", require: false
+ gem "capistrano-rails", "~> 1.1", require: false
+ gem "capistrano-rbenv", "~> 2.0", require: false # production server use rbenv
end
...
...
安裝 gem
bundle install

跑 capistrano install
cap install

設定 config/deploy.rb
原本

config/deploy.rb
# config valid only for current version of Capistrano
lock '3.3.5'

- set :application, 'my_app_name'
+ # 你的 application name
+ set :application, 'rails101s'

- set :repo_url, 'git@example.com:me/my_repo.git'
+ # 你的 git url
+ set :repo_url, 'https://github.com/sdlong/rails101s.git'

+ # rbenv 的設定
+ set :rbenv_type, :user
+ set :rbenv_ruby, "2.1.2"
+ set :rbenv_path, "/usr/local/rbenv"
+ set :rbenv_prefix, "RBENV_ROOT=#{fetch(:rbenv_path)} RBENV_VERSION=#{fetch(:rbenv_ruby)} #{fetch(:rbenv_path)}/bin/rbenv exec"
+ set :rbenv_map_bins, %w(rake gem bundle ruby rails)
+ set :rbenv_roles, :all

# Default deploy_to directory is /var/www/my_app_name
- # set :deploy_to, '/var/www/my_app_name'
+ # deploy 的資料夾位置 (prodution)
+ set :deploy_to, "/home/apps/rails101"

# Default value for :log_level is :debug
- # set :log_level, :debug
+ set :log_level, :debug

# Default value for :linked_files is []
- # set :linked_files, fetch(:linked_files, []).push('config/database.yml')
+ # git clone 完成後會從 shared 資料夾 copy 過去的檔案
+ set :linked_files, %w(config/database.yml config/secrets.yml)

# Default value for linked_dirs is []
- # set :linked_dirs, fetch(:linked_dirs, []).push('bin', 'log', 'tmp/pids', 'tmp/cache', 'tmp/sockets', 'vendor/bundle', 'public/system')
+ # git clone 完成後會從 shared 資料夾 copy 過去的資料夾
+ set :linked_dirs, fetch(:linked_dirs, []).push("bin", "log", "tmp/pids", "tmp/cache", "tmp/sockets", "vendor/bundle", "public/system")

# Default branch is :master
# ask :branch, proc { `git rev-parse --abbrev-ref HEAD`.chomp }.call

# Default value for :scm is :git
# set :scm, :git

# Default value for :format is :pretty
# set :format, :pretty

# Default value for :pty is false
# set :pty, true


# Default value for default_env is {}
# set :default_env, { path: "/opt/ruby/bin:$PATH" }

# Default value for keep_releases is 5
# set :keep_releases, 5

namespace :deploy do

  after :restart, :clear_cache do
    on roles(:web), in: :groups, limit: 3, wait: 10 do
      # Here we can do anything such as:
-     # within release_path do
-     #   execute :rake, 'cache:clear'
-     # end
+     within release_path do
+       execute :rake, 'cache:clear'
+     end
    end
  end

end
設定 Capfile
Capfile
...
...
# require 'capistrano/rvm'
- # require 'capistrano/rbenv'
+ require 'capistrano/rbenv'
# require 'capistrano/chruby'
- # require 'capistrano/bundler'
+ require 'capistrano/bundler' # 會自動幫你跑 bundle install
- # require 'capistrano/rails/assets'
+ require 'capistrano/rails/assets' # 會自動幫你跑 rake assets:precompile
- # require 'capistrano/rails/migrations'
+ require 'capistrano/rails/migrations' # 會自動幫你跑 rake db:migrate
# require 'capistrano/passenger'

...
...
設定 config/deploy/production.rb
config/deploy/production.rb
...
...
- role :app, %w{deploy@example.com}
- role :web, %w{deploy@example.com}
- role :db,  %w{deploy@example.com}
+ # 你設定的 deploy 用帳號 & ip ( 本教材的 ip 是範例 )
+ role :app, %w{apps@106.185.49.108}
+ role :web, %w{apps@106.185.49.108}
+ role :db,  %w{apps@106.185.49.108}
...
- server 'example.com', user: 'deploy', roles: %w{web app}, my_property: :my_value
+ # server 'example.com', user: 'deploy', roles: %w{web app}, my_property: :my_value
...
...
執行 deploy:check
cap production deploy:check
將會做 deploy 前的檢查，並把遠端 (production) 需要的資料夾建立，如果有 error 請檢查錯誤訊息去 debug

執行 deploy 程序
cap production deploy
正式運作自動化 deploy

修改 nginx.conf
由於 capristrano 將專案的位置改到 rails101s/current 所以要將 nginx 上 server 對應的位置修改

sudo vim /opt/nginx/conf/nginx.conf

/opt/nginx/conf/nginx.conf
...
...
    server {
        listen       80;
        server_name  localhost;
-       root /home/apps/rails101s/public;
+       root /home/apps/rails101s/current/public;
        passenger_enabled on;
    }
...
...
重開 nginx, 看看是否 deploy 成功
sudo /etc/init.d/nginx restart

=> 用瀏覽器瀏覽你的網站吧！

以後專案有任何異動，只要 push 到 github ( master 主線 ) 以後
直接輸入 cap production deploy 即可自動跑完 deploy

萬一新版本的專案炸掉，還可以輸入 cap production deploy:rollback 回溯上個版本

production 端的 rails101s 根目錄會有三個資料夾

current <== 現在實際上線運作的版本
releases <== 你過去 deploy 的記錄 ( 預設存五個 , 最新版的 = current )
shared <== 你不想放在 git 上給人看到的檔案(例如 database.yml) / logs / 圖片 ... etc 的放置處，新版本 deploy 完後 capristrano 會自動 copy 一份過去到 current 上

現在根目錄除了這三個資料以外的檔案都沒有用到了，如果嫌太亂可以這些檔案刪除掉


How to use 谷歌
http://yuezaixz.logdown.com/posts/175283-how-to-use-google


How To Install Rails and nginx with Passenger on Ubuntu
https://www.digitalocean.com/community/tutorials/how-to-install-rails-and-nginx-with-passenger-on-ubuntu

nginx + unicorn + capistrano 部署
https://www.jianshu.com/p/f47538a02ab5

Ubuntu 16.04 安装 Redmine项目管理系统（Nginx）
http://blog.topspeedsnail.com/archives/9131

如何在Mac下快速部署 Nginx + Passenger + Rails
http://www.dedecms.com/knowledge/program/ruby/2012/1202/17184.html

如何在Mac下快速部署 Nginx + Passenger + Rails
来源：ruby-china 作者：ruby-china 发表于：2012-12-02 10:45　 点击：651
针对于新入门的开发者，如何在 Mac 下用 Nginx + Passenger 部署 Rails 的运行环境。 系统需求 Mac OSX Lion 步骤0 安装环境依赖 安装Xcode 4.1，Xcode4.2以及更高的版本在 Lion 仍然存在一些兼容性问题，强烈建议使用XCode 4.1，下载地址： https://develop

针对于新入门的开发者，如何在 Mac 下用 Nginx + Passenger 部署 Rails 的运行环境。

系统需求
Mac OSX Lion
步骤0 安装环境依赖
安装Xcode 4.1，Xcode4.2以及更高的版本在 Lion 仍然存在一些兼容性问题，强烈建议使用XCode 4.1，下载地址：

https://developer.apple.com/downloads/download.action?path=Developer_Tools/xcode_4.1_for_lion/xcode_4.1_for_lion.dmg
安装RVM

$ bash < <(curl -s https://raw.github.com/wayneeseguin/rvm/master/binscripts/rvm-installer)
配置RVM自动加载，将下面这一行代码添加到~/.bash_profile中，然后退出iTerm并重新启动

[[ -s $HOME/.rvm/scripts/rvm ]] && source $HOME/.rvm/scripts/rvm
安装 ruby-1.9.2-p290

$ rvm install 1.9.2
设置系统默认使用 ruby-1.9.2

$ rvm use 1.9.2 --default
步骤1 安装 Rails
安装Rails

$ gem install rails
Rails安装完成后，创建一个rails项目，假定你的项目叫做：awesome project

$ rails new awesome_project
启动Rails，并访问 http://localhost:3000

$ cd awesome_project
$ rails server
步骤2 安装 Passenger 和 Nginx
首先通过gem安装passenger

$ gem install passenger
因为Nginx不支持动态module载入，所以需要通过Passenger来自动下载，编译，安装由Passenger修改版的Nginx:

安装Passenger + Nginx

$ passenger-install-nginx-module
Yes: download, compile and install Nginx for me. (recommended)
The easiest way to get started. A stock Nginx 1.0.10 with Passenger
support, but with no other additional third party modules, will be
installed for you to a directory of your choice.

No: I want to customize my Nginx installation. (for advanced users)
Choose this if you want to compile Nginx with more third party modules
besides Passenger, or if you need to pass additional options to Nginx's
'configure' script. This installer will 1) ask you for the location of
the Nginx source code, 2) run the 'configure' script according to your
instructions, and 3) run 'make install'.

Whichever you choose, if you already have an existing Nginx configuration file,
then it will be preserved.

Enter your choice (1 or 2) or press Ctrl-C to abort: 这里建议选择1

Please specify a prefix directory [/opt/nginx]: /usr/local/nginx

当询问nginx的安装路径的时候，个人建议安装到/usr/local/nginx下

当安装完成后，会在console中提示如何配置Nginx

Passenger会自动帮你将下面两行添加到Nginx的配置文件中/usr/local/nginx/conf/nginx.conf（很人性化）

http {
  ...
  passenger_root /Users/Daniel/.rvm/gems/ruby-1.9.2-p290/gems/passenger-3.0.10;
  passenger_ruby /Users/Daniel/.rvm/wrappers/ruby-1.9.2-p290/ruby;
  ...
}
server {
  listen 80;
  server_name www.yourhost.com;
  root /somewhere/public;   # <--- be sure to point to 'public'!
  passenger_enabled on;
}
请不要忘记将nginx命令行程序连接到/usr/local/sbin

$ sudo ln -s /usr/local/nginx/sbin/nginx /usr/sbin/
步骤3 配置Nginx + Passenger + Rails
关于Nginx的配置，请参考Nginx的官方网站以及Passenger的官方网站

http://wiki.nginx.org/Configuration
http://www.modrails.com/documentation/Users%20guide%20Nginx.html
修改hosts文件，给你的项目一个本地域名, 比如awesome_project.local

$ sudo vim /etc/hosts
127.0.0.1 awesome_project.local
测试hosts

$ ping awesome_project.local
PING awesome_project.local (127.0.0.1): 56 data bytes
64 bytes from 127.0.0.1: icmp_seq=0 ttl=64 time=0.054 ms
继续配置Nginx, 这里我给出一个最小可运行的Nginx配置文件

$ vim /usr/local/nginx/conf/nginx.conf
nginx.conf

worker_processes 1; events { worker_connections 1024; } http { passenger_root /Users/Daniel/.rvm/gems/ruby-1.9.2-p290/gems/passenger-3.0.10; passenger_ruby /Users/Daniel/.rvm/wrappers/ruby-1.9.2-p290/ruby; include mime.types; default_type application/octet-stream; sendfile on; keepalive_timeout 65; server { listen 80; server_name awesome_project.local; root /Users/Daniel/awesome_project/public; passenger_enabled on; rails_env development; } }
测试Nginx的配置文件语法是否正确

$ sudo nginx -t
nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful
启动Nginx

$ sudo nginx
如何在修改Nginx的配置文件后，让Nginx载入新配置

$ sudo nginx -s reload
如何停止Nginx

$ sudo nginx -s stop
如何在不停Nginx的情况下，重新启动Passenger

$ cd path/to/your/awesome/project $ touch tmp/restart.txt
好了，这个时候你可以打开浏览器，访问你的awesome_project网站了

http://awesome_project.local
最后，希望你能够在Rails的开发中找到快乐！


rails 生产环境部署练习（nginx + passenger + capistrano）
http://blog.csdn.net/ximi_qin287624952/article/details/70169614

自己实践：两台 ubuntu 系统间的部署 ，从上到下，一步一步去实现

第一步： 安装网站服务器 ( ubuntu 16.04 )

第二步：安装 ruby、rails 环境

$ sudo apt update
$ sudo apt upgrade -y
$ sudo dpkg-reconfigure tzdata
1
2
3
进入选单选你的 Time zone=>Asia=>chongqing | shanghai

接着我们安装新的套件们，这些是 Ruby on Rails 所需要的东西。请输入以下一行指令：

$ sudo apt install -y build-essential git-core bison openssl libreadline6-dev curl zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3  autoconf libc6-dev libpcre3-dev curl libcurl4-nss-dev libxml2-dev libxslt-dev imagemagick nodejs libffi-dev
1
安装 ruby 慢放法：自行编译原始码

$ wget http://cache.ruby-lang.org/pub/ruby/2.4/ruby-2.4.0.tar.gz
$ tar xvfz ruby-2.4.0.tar.gz
$ cd ruby-2.4.0
$ ./configure
$ make
$ sudo make install
1
2
3
4
5
6
请把 2.4.0 换成你项目使用的 ruby 版本号

$ ruby -v
$ gem install bundler
$ bundler -v
1
2
3
安装 postgresql 数据库

$ sudo apt install postgresql libpq-dev postgresql-contrib
1
修改帐号 postgres 的密码

切换到 postgres 用户

$ sudo su - postgres
1
使用 psql 命令登录 postgresql 控制台

$ psql
1
使用 \password 命令，为 postgres 用户设置一个密码

> \password your_password
1
创建数据库

> CREATE DATABASE your_app_database_name OWNER postgrs;
1
退出

\q
第三步：安装 Nginx + Passenger 快方法：用套件安装

$ sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7

$ sudo apt install -y apt-transport-https ca-certificates

# Add our APT repository
$ sudo sh -c 'echo deb https://oss-binaries.phusionpassenger.com/apt/passenger xenial main > /etc/apt/sources.list.d/passenger.list'

$ sudo apt update

# Install Passenger + Nginx
$ sudo apt install -y nginx-extras passenger
1
2
3
4
5
6
7
8
9
10
11
打开你的浏览器，输入 服务器 IP 地址，应该就可以看到默认的 Nginx 网页了：Welcome to nginx on Ubuntu!

Nginx启动和重开用法：

$ sudo service nginx start
$ sudo service nginx stop
$ sudo service nginx restart
1
2
3
第四步：新增 deploy 用户

$ sudo adduser --disabled-password deploy
$ sudo su deploy
$ cd ~
$ ssh-keygen -t rsa
1
2
3
4
接着复制开发机器的 ~/.ssh/id_rsa.pub 到 服务器的 /home/deploy/.ssh/authorized_keys

在本机电脑 Terminal 输入 cat ~/.ssh/id_rsa.pub，会出现一串文字，复制下来
在 服务器 Terminal 上输入 vi /home/deploy/.ssh/authorized_keys，进入vi去编辑该档，把上一个步骤的视窗内的文字copy贴上到vi内，然后 :wq 离开

$ chmod 644 /home/deploy/.ssh/authorized_keys
$ chown deploy:deploy /home/deploy/.ssh/authorized_keys
1
2
这样开发机器就可以直接 ssh deploy@<服务器IP地址>，登入无须密码

备注：还需将服务器的 /home/deploy/.ssh/id_rsa.pub 复制到代码远程仓库 ssh_keys

第五步：设定 Nginx

输入 exit 回到 root 帐号

编辑 /etc/nginx/nginx.conf，去掉注释打开以下一行：

include /etc/nginx/passenger.conf;
1
在 /etc/nginx/nginx.conf最上方新增一行：

env PATH;
1
少这一行的话，等会 Rails 会找不到 nodejs 的路径，在 nginx error log 中会有 Message from application: There was an error while trying to load the gem ‘uglifier’. Gem Load Error is: Could not find a JavaScript runtime. See https://github.com/rails/execjs for a list of available runtimes. 的错误。

新增 /etc/nginx/sites-enabled/your_project_name.conf

server {
  listen 80;
  server_name your_domain.com; # 还没 domain 的话，先填 服务器 IP 地址

  root /home/deploy/your_app_name/public;
  # 如果是自动化部署，位置在 root /home/deploy/apps/your_app_name/current/public;

  passenger_enabled on;

  passenger_min_instances 1;

  location ~ ^/assets/ {
    expires 1y;
    add_header Cache-Control public;
    add_header ETag "";
    break;
   }
}
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
以上设定包括设定Assets静态档案成为永不过期(Rails的Assets Pipeline会加上版本号，所以不需要担心)、设定Passenger至少开一个Process。其中server_name your_domain.com请会换成你的domain。如果Domain name还没注册好，可以先用服务器IP地址。但是如果你的服务器上有多个Rails专案或网站，就必须用不同domain来区分。

如果有多个domain连到同一个服务器，可以用空白区隔，例如：

server_name dureading.calvinchu.cc dureading.com www.dureading.com;
1
这样三个 domain 都会连到同一个 Rails 了。

最后执行sudo service nginx restart便会启用Nginx设定。如果之后你的Rails有任何修改要重新加载，但是并不想把Nginx整个重开，请在你的Rails应用程式目录下执行touch tmp/restart.txt即可，这样Passenger就会知道要重新加载Rails，而不需要重开Nginx。

第六步：使用 capistrano 设定自动化布署脚本

在Gemfile中添加Capistrano和其它用到的插件

group :development do
  gem 'capistrano'
  gem 'capistrano-rails'
  gem 'capistrano-bundler'
  gem 'capistrano-passenger'
end
1
2
3
4
5
6
在项目中初始化 Capistrano

$ cap install
会生成如下目录文件，Capfile 用来配置 Capistrano，deploy.rb 是一些共用 task 的定义，而 production.rb / staging.rb 用来定义具体的 stage 的 tasks。

├── Capfile
├── config
│ ├── deploy
│ │ ├── production.rb
│ │ └── staging.rb
│ └── deploy.rb
└── lib
└── capistrano
└── tasks

配置 Capistrano

在 Capfile 文件中开启要用到的一些插件

require 'capistrano/setup'
require 'capistrano/deploy'

require 'capistrano/rails'
require 'capistrano/passenger'

require "capistrano/scm/git"
install_plugin Capistrano::SCM::Git

require 'capistrano/bundler'
require 'capistrano/rails/assets'
require 'capistrano/rails/migrations'

Dir.glob('lib/capistrano/tasks/*.cap').each { |r| import r }
1
2
3
4
5
6
7
8
9
10
11
12
13
14
在 config/deploy.rb 文件中配置共用变量

lock "3.7.2"

set :application, 'your_app_name'
set :deploy_user, 'deploy'

set :repo_url, 'git@bitbucket.org:your_user_id/your_app_name.git' # 项目代码远程仓库地址 github,bitbucket 或者其它代码管理仓库

# how many old releases do we want to keep, not much
set :keep_releases, 5

# files we want symlinking to specific entries in shared
set :linked_files, %w{config/database.yml config/secrets.yml}

# dirs we want symlinking to shared
set :linked_dirs, %w{bin log tmp/pids tmp/cache tmp/sockets vendor/bundle public/system}

namespace :deploy do
  after :finishing, 'deploy:cleanup'
end

`ssh-add`  # 注意这是键盘左上角的「 `」不是单引号「 '」
set :passenger_restart_with_touch, true

在 config/deploy/production.rb 中配置具体的 stage 的 tasks

set :stage, :production # 部署的环境
set :branch, 'master' # 部署的代码分支
set :rails_env, :production

server 'xxx.xxx.xxx.xxx', user: "#{fetch(:deploy_user)}", roles: %w{app db web}  # server 填域名或者服务器的 IP 地址

set :deploy_to, "/home/#{fetch(:deploy_user)}/apps/#{fetch(:application)}" # 部署到服务器的位置

set :enable_ssl, false
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
开始部署

在开发机器终端运行

$ cap production deploy --dry-run 或者 $ cap production deploy:check
1
2
使用 ssh deploy@your_server_ip 登入服务器，在deploy/home/apps/your_app_name/shared/config目录下新建 database.yml 和 secrets.yml

在服务器终端运行

$ touch ~/apps/your_app_name/shared/config/database.yml
$ touch ~/apps/your_app_name/shared/config/secrets.yml
1
2
在开发机器项目目录下执行 rake secret 产生的 key 放到服务器的~/apps/your_app_name/shared/config/secrets.yml，范例如下：

production:
  secret_key_base: xxxxxxx........
1
2
用 vim 编辑服务器文件 ~/apps/your_app_name/shared/config/database.yml，范例如下:

production:
  adapter: postgresql
  encoding: unicode
  database: your_app_database_name
  host: localhost
  pool: 25
  username: postgres
  password: your_password
1
2
3
4
5
6
7
8
在开发机器终端执行部署命令

$ cap production deploy
1
在服务器重启 nginx

$ sudo service nginx restart
1
第七步：访问页面

在浏览器访问服务器的IP地址 或者 你的域名，没有意外的话就可以看到你项目的主页面了。

恭喜你！

参考网址：
https://ihower.tw/rails/deployment-cn.html
https://ruby-china.org/topics/18616
http://www.ruanyifeng.com/blog/2013/12/getting_started_with_postgresql.html

说明：本文仅用于学习，多处文本复制于参考文献，若涉及原作者版权，通知到本人将立即删除本文。

**田文艺工作总结**
 - 上午：微信图文编辑推送
 - 下午：视频编辑+微信内容编辑
 **张家琛工作总结**
 -  整理阿里云部署文档

